name: Android APK Build

permissions:
  contents: write

on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµï¼Œæ”¯æŒæŒ‡å®šä»“åº“URL
  workflow_dispatch:
    inputs:
      repository_url:
        description: 'Git repository URL'
        required: false
        type: string
      checkout_options:
        description: 'checkout options (e.g., -b branch_name --depth=1)'
        required: false
        default: '--depth=1'
        type: string
      build_command:
        description: 'Build command'
        required: true
        default: 'bash gradlew asDebug'
        type: string

jobs:
  build-apk:
    name: Build Android APK
    runs-on: ubuntu-latest
    steps:
      # æ£€å‡ºæŒ‡å®šä»“åº“ï¼ˆæ”¯æŒè‡ªå®šä¹‰URLï¼‰
      - name: Checkout Repository
        run: |
          git clone ${{ github.event.inputs.repository_url }} ${{ github.event.inputs.checkout_options}} .

      # åªæ£€æµ‹JDKç‰ˆæœ¬
      - name: Detect JDK Version Only
        id: detect-jdk
        run: |
          echo "ğŸ” æ­£åœ¨æ£€æµ‹é¡¹ç›®æ‰€éœ€çš„JDKç‰ˆæœ¬..."

          # å¤šç§æ£€æµ‹æ–¹å¼ï¼ŒæŒ‰ä¼˜å…ˆçº§é™åº
          JDK_VERSION=""

          # æ£€æŸ¥gradle-wrapper.propertiesä¸­çš„Gradleç‰ˆæœ¬ï¼Œæ¨æ–­JDKç‰ˆæœ¬
          if [ -z "$JDK_VERSION" ] && [ -f "gradle/wrapper/gradle-wrapper.properties" ]; then
            GRADLE_VERSION=$(grep "distributionUrl" gradle/wrapper/gradle-wrapper.properties | grep -oE 'gradle-[0-9]+\.[0-9]+' | cut -d'-' -f2 | cut -d'.' -f1)
            if [ -n "$GRADLE_VERSION" ]; then
              # Gradle 5.xåŠä»¥ä¸Šéœ€è¦JDK 8ï¼ŒGradle 7.xéœ€è¦JDK 11ï¼ŒGradle 8.xéœ€è¦JDK 17
              if [ "$GRADLE_VERSION" -ge 9 ]; then
                JDK_VERSION=21
              elif [ "$GRADLE_VERSION" -ge 8 ]; then
                JDK_VERSION=17
              elif [ "$GRADLE_VERSION" -ge 7 ]; then
                JDK_VERSION=11
              elif [ "$GRADLE_VERSION" -ge 5 ]; then
                JDK_VERSION=8
              else
                JDK_VERSION=8
              fi
              echo "âœ… ä» Gradle $GRADLE_VERSION æ¨æ–­ JDK ç‰ˆæœ¬: $JDK_VERSION"
            fi
          fi

          # 6. é»˜è®¤ä½¿ç”¨JDK 11
          if [ -z "$JDK_VERSION" ]; then
            JDK_VERSION=11
            echo "âš ï¸ æœªæ£€æµ‹åˆ°JDKé…ç½®ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬: 11"
          fi

          # è¾“å‡ºæ£€æµ‹ç»“æœ
          echo "jdk_version=$JDK_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ æœ€ç»ˆä½¿ç”¨çš„JDKç‰ˆæœ¬: $JDK_VERSION"

          # è¾“å‡ºä»“åº“ä¿¡æ¯
          echo "ğŸ“¦ æ£€å‡ºä»“åº“: ${{ github.event.inputs.repository_url }}"

      # æ˜¾ç¤ºä»“åº“ä¿¡æ¯
      - name: Display Repository Info
        run: |
          echo "ğŸ  å½“å‰ä»“åº“ä¿¡æ¯:"
          echo "  Remote URL: $(git remote get-url origin 2>/dev/null || echo 'N/A')"
          echo "  Branch: $(git rev-parse --abbrev-ref HEAD)"
          echo "  Commit: $(git rev-parse --short HEAD)"
          echo "  Commit Message: $(git log -1 --pretty=%s)"

      # è®¾ç½®JDK
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: ${{ steps.detect-jdk.outputs.jdk_version }}
          distribution: 'temurin'
          cache: gradle

      # ç¼“å­˜Gradleä¾èµ–
      - name: Cache Gradle Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            !~/.gradle/caches/build-cache-*
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # æ„å»ºAPK
      - name: Build APK
        id: build
        run: echo ${{ github.event.inputs.build_command }} | bash

      # ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
      - name: Generate Version Info
        id: version
        run: |
          # ç”Ÿæˆç‰ˆæœ¬å·
          COMMIT_HASH=$(git rev-parse --short HEAD)
          BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD | sed 's/\//-/g')
          BUILD_DATE=$(date '+%Y%m%d-%H%M%S')
          BUILD_NUMBER=${GITHUB_RUN_NUMBER}
          
          VERSION_NAME="${BUILD_DATE}-${COMMIT_HASH}"
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ç‰ˆæœ¬åç§°: $VERSION_NAME"
          echo "ğŸ“¦ ç‰ˆæœ¬ä»£ç : $BUILD_NUMBER"
      # ç”Ÿæˆæ„å»ºæŠ¥å‘Š
      - name: Generate Build Report
        if: always()
        run: |
          {
            echo "# Android APK æ„å»ºæŠ¥å‘Š"
            echo ""
            echo "## ğŸ“‹ æ„å»ºä¿¡æ¯"
            echo "- **æ„å»ºçŠ¶æ€**: ${{ steps.build.outputs.build_status }}"
            echo "- **æ„å»ºå‘½ä»¤**: ${{ steps.build.outputs.build_command }}"
            echo "- **JDKç‰ˆæœ¬**: ${{ steps.detect-jdk.outputs.jdk_version }}"
            echo "- **ç‰ˆæœ¬åç§°**: ${{ steps.version.outputs.version_name }}"
            echo "- **ç‰ˆæœ¬ä»£ç **: ${{ steps.version.outputs.version_code }}"
            echo ""
            echo "## ğŸ“¦ ä»“åº“ä¿¡æ¯"
            echo "- **ä»“åº“URL**: ${{ github.event.inputs.repository_url }}"
            echo "- **æ£€å‡ºå‚æ•°**: ${{ github.event.inputs.checkout_options }}"
            echo "- **æäº¤**: ${{ github.sha }}"
            echo "- **å·¥ä½œæµ**: ${{ github.workflow }}"
            echo "- **è¿è¡ŒID**: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            START_TIME=${{ steps.build.outputs.start_time }}
            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))
            MINUTES=$((DURATION / 60))
            SECONDS=$((DURATION % 60))
            echo "- **æ„å»ºæ—¶é•¿**: ${MINUTES}åˆ†${SECONDS}ç§’"
            echo ""
          } > build-report.md
          
          echo "ğŸ“ æ„å»ºæŠ¥å‘Šå·²ç”Ÿæˆ"
          cat build-report.md

      # ä¸Šä¼ APK
      - name: Upload APK release
        uses: ncipollo/release-action@v1
        with:
          tag: "${{ steps.version.outputs.version_name }}"
          draft: false
          artifacts: "**/outputs/apk/**/*.apk"
          makeLatest: "latest"
          allowUpdates: true
          bodyFile: build-report.md

      # ä¸Šä¼ æ„å»ºæŠ¥å‘Š
      - name: Upload Build Report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: build-report-${{ steps.version.outputs.version_name }}
          path: build-report.md
          retention-days: 90