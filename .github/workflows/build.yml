name: Android APK Build

permissions:
  contents: write

on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµï¼Œæ”¯æŒæŒ‡å®šä»“åº“URL
  workflow_dispatch:
    inputs:
      repository_url:
        description: 'Git repository URL'
        required: true
        type: string
      checkout_options:
        description: 'checkout options (e.g., -b branch_name --depth=1)'
        required: false
        default: '--depth=1'
        type: string
      build_command:
        description: 'Build command'
        required: true
        default: 'bash gradlew asDebug'
        type: string
      artifacts_pattern:
        description: 'Artifacts pattern to upload'
        required: false
        default: '**/outputs/apk/**/*.apk'
        type: string

jobs:
  build-apk:
    name: Build Android APK
    runs-on: ubuntu-latest
    steps:
      # æ£€å‡ºæŒ‡å®šä»“åº“ï¼ˆæ”¯æŒè‡ªå®šä¹‰URLï¼‰
      - name: Checkout Repository
        run: |
          git clone ${{ github.event.inputs.repository_url }} ${{ github.event.inputs.checkout_options}} .

      # æ£€æµ‹JDKç‰ˆæœ¬
      - name: Detect JDK Version
        id: detect-jdk
        run: |
          JDK_VERSION=11
          if [ -f "gradle/wrapper/gradle-wrapper.properties" ]; then
            GRADLE_VERSION=$(grep "distributionUrl" gradle/wrapper/gradle-wrapper.properties | grep -oE 'gradle-[0-9]+' | cut -d'-' -f2)
            case $GRADLE_VERSION in
              9|1[0-9]) JDK_VERSION=21 ;;
              8) JDK_VERSION=17 ;;
              7) JDK_VERSION=11 ;;
            esac
          fi
          echo "jdk_version=$JDK_VERSION" >> $GITHUB_OUTPUT

      # è®¾ç½®JDK
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: ${{ steps.detect-jdk.outputs.jdk_version }}
          distribution: 'temurin'
          cache: gradle

      # æ„å»ºAPK
      - name: Build APK
        id: build
        run: echo ${{ github.event.inputs.build_command }} | bash

      # ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
      - name: Generate Version Info
        id: version
        run: |
          # ç”Ÿæˆç‰ˆæœ¬å·
          COMMIT_HASH=$(git rev-parse --short HEAD)
          BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD | sed 's/\//-/g')
          BUILD_DATE=$(date '+%Y%m%d-%H%M%S')
          BUILD_NUMBER=${GITHUB_RUN_NUMBER}
          
          VERSION_NAME="${BUILD_DATE}-${COMMIT_HASH}"
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ç‰ˆæœ¬åç§°: $VERSION_NAME"
          echo "ğŸ“¦ ç‰ˆæœ¬ä»£ç : $BUILD_NUMBER"
      # ç”Ÿæˆæ„å»ºæŠ¥å‘Š
      - name: Generate Build Report
        if: always()
        run: |
          cat > build-report.md <<EOF
          # Android APK æ„å»ºæŠ¥å‘Š

          ## ğŸ“‹ æ„å»ºä¿¡æ¯
          - **æ„å»ºå‘½ä»¤**: ${{ github.event.inputs.build_command }}
          - **JDKç‰ˆæœ¬**: ${{ steps.detect-jdk.outputs.jdk_version }}
          - **ç‰ˆæœ¬åç§°**: ${{ steps.version.outputs.version_name }}
          - **ç‰ˆæœ¬ä»£ç **: ${{ steps.version.outputs.version_code }}

          ## ğŸ“¦ ä»“åº“ä¿¡æ¯
          - **ä»“åº“URL**: ${{ github.event.inputs.repository_url }}
          - **æ£€å‡ºå‚æ•°**: ${{ github.event.inputs.checkout_options }}
          - **æäº¤**: ${{ github.sha }}
          - **è¿è¡ŒID**: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF
          cat build-report.md

      # ä¸Šä¼ APK
      - name: Upload APK release
        uses: ncipollo/release-action@v1
        with:
          tag: "${{ steps.version.outputs.version_name }}"
          draft: false
          artifacts: "${{ github.event.inputs.artifacts_pattern }}"
          makeLatest: "latest"
          allowUpdates: true
          bodyFile: build-report.md
