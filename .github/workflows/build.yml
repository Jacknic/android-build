name: Android APK Build

permissions:
  contents: write

on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµï¼Œæ”¯æŒæŒ‡å®šä»“åº“URL
  workflow_dispatch:
    inputs:
      repository_url:
        description: 'Git repository URL'
        required: false
        type: string
      branch:
        description: 'Branch to checkout'
        required: false
        default: ''
        type: string
      build_type:
        description: 'Build type (debug/release)'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
      upload_artifact:
        description: 'Upload APK as artifact'
        required: true
        default: true
        type: boolean

# ç¯å¢ƒå˜é‡
env:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true"
  BUILD_TYPE: ${{ github.event.inputs.build_type || 'debug' }}

jobs:
  build-apk:
    name: Build Android APK
    runs-on: ubuntu-latest
    steps:
      # æ£€å‡ºæŒ‡å®šä»“åº“ï¼ˆæ”¯æŒè‡ªå®šä¹‰URLï¼‰
      - name: Checkout Repository
        run: |
          git clone ${{ github.event.inputs.repository_url }} --depth=1 .

      # åªæ£€æµ‹JDKç‰ˆæœ¬
      - name: Detect JDK Version Only
        id: detect-jdk
        run: |
          echo "ğŸ” æ­£åœ¨æ£€æµ‹é¡¹ç›®æ‰€éœ€çš„JDKç‰ˆæœ¬..."

          # å¤šç§æ£€æµ‹æ–¹å¼ï¼ŒæŒ‰ä¼˜å…ˆçº§é™åº
          JDK_VERSION=""

          # æ£€æŸ¥gradle-wrapper.propertiesä¸­çš„Gradleç‰ˆæœ¬ï¼Œæ¨æ–­JDKç‰ˆæœ¬
          if [ -z "$JDK_VERSION" ] && [ -f "gradle/wrapper/gradle-wrapper.properties" ]; then
            GRADLE_VERSION=$(grep "distributionUrl" gradle/wrapper/gradle-wrapper.properties | grep -oE 'gradle-[0-9]+\.[0-9]+' | cut -d'-' -f2 | cut -d'.' -f1)
            if [ -n "$GRADLE_VERSION" ]; then
              # Gradle 5.xåŠä»¥ä¸Šéœ€è¦JDK 8ï¼ŒGradle 7.xéœ€è¦JDK 11ï¼ŒGradle 8.xéœ€è¦JDK 17
              if [ "$GRADLE_VERSION" -ge 9 ]; then
                JDK_VERSION=21
              elif [ "$GRADLE_VERSION" -ge 8 ]; then
                JDK_VERSION=17
              elif [ "$GRADLE_VERSION" -ge 7 ]; then
                JDK_VERSION=11
              elif [ "$GRADLE_VERSION" -ge 5 ]; then
                JDK_VERSION=8
              else
                JDK_VERSION=8
              fi
              echo "âœ… ä» Gradle $GRADLE_VERSION æ¨æ–­ JDK ç‰ˆæœ¬: $JDK_VERSION"
            fi
          fi

          # 6. é»˜è®¤ä½¿ç”¨JDK 11
          if [ -z "$JDK_VERSION" ]; then
            JDK_VERSION=11
            echo "âš ï¸ æœªæ£€æµ‹åˆ°JDKé…ç½®ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬: 11"
          fi

          # è¾“å‡ºæ£€æµ‹ç»“æœ
          echo "jdk_version=$JDK_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ æœ€ç»ˆä½¿ç”¨çš„JDKç‰ˆæœ¬: $JDK_VERSION"

          # è¾“å‡ºä»“åº“ä¿¡æ¯
          if [ -n "${{ github.event.inputs.repository_url }}" ]; then
            echo "ğŸ“¦ æ£€å‡ºä»“åº“: ${{ github.event.inputs.repository_url }}"
            echo "ğŸŒ¿ æ£€å‡ºåˆ†æ”¯: ${{ github.event.inputs.branch || 'main' }}"
          else
            echo "ğŸ“¦ ä½¿ç”¨å½“å‰ä»“åº“: ${{ github.repository }}"
          fi

      # æ˜¾ç¤ºä»“åº“ä¿¡æ¯
      - name: Display Repository Info
        run: |
          echo "ğŸ  å½“å‰ä»“åº“ä¿¡æ¯:"
          echo "  Remote URL: $(git remote get-url origin 2>/dev/null || echo 'N/A')"
          echo "  Branch: $(git rev-parse --abbrev-ref HEAD)"
          echo "  Commit: $(git rev-parse --short HEAD)"
          echo "  Commit Message: $(git log -1 --pretty=%s)"

      # è®¾ç½®JDKï¼ˆä½¿ç”¨æ£€æµ‹åˆ°çš„ç‰ˆæœ¬ï¼‰
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: ${{ steps.detect-jdk.outputs.jdk_version }}
          distribution: 'temurin'
          cache: gradle

      # éªŒè¯JDKç‰ˆæœ¬
      - name: Verify JDK Version
        run: |
          echo "ğŸ”§ JDKé…ç½®ä¿¡æ¯:"
          echo "  é…ç½®ç‰ˆæœ¬: ${{ steps.detect-jdk.outputs.jdk_version }}"
          echo "  å®é™…ç‰ˆæœ¬:"
          java -version 2>&1
          javac -version 2>&1
          
          # éªŒè¯ç‰ˆæœ¬åŒ¹é…
          CURRENT_VERSION=$(java -version 2>&1 | head -1 | cut -d'"' -f2 | cut -d'.' -f1)
          if [ "$CURRENT_VERSION" = "1" ]; then
            CURRENT_VERSION=8
          fi
          
          echo "  æ£€æµ‹åˆ°å®é™…JDKä¸»ç‰ˆæœ¬: $CURRENT_VERSION"
          if [ "$CURRENT_VERSION" != "${{ steps.detect-jdk.outputs.jdk_version }}" ]; then
            echo "âš ï¸ è­¦å‘Š: å®é™…JDKç‰ˆæœ¬($CURRENT_VERSION)ä¸æ£€æµ‹ç‰ˆæœ¬(${{ steps.detect-jdk.outputs.jdk_version }})ä¸ä¸€è‡´"
          else
            echo "âœ… JDKç‰ˆæœ¬éªŒè¯é€šè¿‡"
          fi

      # ç¼“å­˜Gradleä¾èµ–
      - name: Cache Gradle Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            !~/.gradle/caches/build-cache-*
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # ç¼“å­˜Gradleæ„å»ºç¼“å­˜
      - name: Cache Gradle Build Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches/build-cache-*
            **/.gradle/build-cache
          key: ${{ runner.os }}-gradle-buildcache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-gradle-buildcache-

      # æˆäºˆæ‰§è¡Œæƒé™
      - name: Grant Execute Permission
        run: |
          if [ -f "gradlew" ]; then
            chmod +x gradlew
            echo "âœ… gradlew å·²æˆäºˆæ‰§è¡Œæƒé™"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° gradlew æ–‡ä»¶"
          fi

      # æ„å»ºAPK
      - name: Build APK
        id: build
        env:
          BUILD_TYPE: ${{ env.BUILD_TYPE }}
        run: |
          echo "ğŸ—ï¸ å¼€å§‹æ„å»ºAPK..."
          echo "   æ„å»ºç±»å‹: $BUILD_TYPE"
          echo "   JDKç‰ˆæœ¬: ${{ steps.detect-jdk.outputs.jdk_version }}"
          
          # æ„å»ºå‘½ä»¤
          BUILD_COMMAND="assemble$(echo $BUILD_TYPE | tr '[:lower:]' '[:upper:]' | cut -c1)$(echo $BUILD_TYPE | cut -c2-)"
          
          if [ -f "gradlew" ]; then
            ./gradlew $BUILD_COMMAND
          else
            gradle $BUILD_COMMAND
          fi
          
          # æ£€æŸ¥æ„å»ºç»“æœ
          if [ $? -eq 0 ]; then
            echo "build_status=success" >> $GITHUB_OUTPUT
            echo "âœ… APKæ„å»ºæˆåŠŸ"
          else
            echo "build_status=failed" >> $GITHUB_OUTPUT
            echo "âŒ APKæ„å»ºå¤±è´¥"
            exit 1
          fi

      # ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
      - name: Generate Version Info
        id: version
        run: |
          # ç”Ÿæˆç‰ˆæœ¬å·
          COMMIT_HASH=$(git rev-parse --short HEAD)
          BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD | sed 's/\//-/g')
          BUILD_DATE=$(date '+%Y%m%d-%H%M%S')
          BUILD_NUMBER=${GITHUB_RUN_NUMBER}
          
          VERSION_NAME="${BUILD_DATE}-${COMMIT_HASH}"
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ç‰ˆæœ¬åç§°: $VERSION_NAME"
          echo "ğŸ“¦ ç‰ˆæœ¬ä»£ç : $BUILD_NUMBER"
      # ç”Ÿæˆæ„å»ºæŠ¥å‘Š
      - name: Generate Build Report
        if: always()
        run: |
          {
            echo "# Android APK æ„å»ºæŠ¥å‘Š"
            echo ""
            echo "## ğŸ“‹ æ„å»ºä¿¡æ¯"
            echo "- **æ„å»ºçŠ¶æ€**: ${{ steps.build.outputs.build_status }}"
            echo "- **æ„å»ºç±»å‹**: ${{ env.BUILD_TYPE }}"
            echo "- **JDKç‰ˆæœ¬**: ${{ steps.detect-jdk.outputs.jdk_version }}"
            echo "- **ç‰ˆæœ¬åç§°**: ${{ steps.version.outputs.version_name }}"
            echo "- **ç‰ˆæœ¬ä»£ç **: ${{ steps.version.outputs.version_code }}"
            echo ""
            echo "## ğŸ“¦ ä»“åº“ä¿¡æ¯"
            echo "- **ä»“åº“URL**: ${{ github.event.inputs.repository_url }}"
            echo "- **åˆ†æ”¯**: ${{ github.event.inputs.branch }}"
            echo "- **æäº¤**: ${{ github.sha }}"
            echo "- **å·¥ä½œæµ**: ${{ github.workflow }}"
            echo "- **è¿è¡ŒID**: ${{ github.run_id }}"
            echo ""
            echo "## ğŸ“± æ„å»ºäº§ç‰©"
            echo "APKæ–‡ä»¶å·²ä¸Šä¼ åˆ°Artifactsï¼Œå¯ä¸‹è½½å®‰è£…"
          } > build-report.md
          
          echo "ğŸ“ æ„å»ºæŠ¥å‘Šå·²ç”Ÿæˆ"
          cat build-report.md

      # ä¸Šä¼ APK
      - name: Upload APK release
        uses: ncipollo/release-action@v1
        with:
          tag: "${{ steps.version.outputs.version_name }}"
          draft: false
          artifacts: "**/outputs/apk/**/*.apk"
          allowUpdates: true
          bodyFile: build-report.md

      # ä¸Šä¼ æ„å»ºæŠ¥å‘Š
      - name: Upload Build Report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: build-report-${{ steps.version.outputs.version_name }}
          path: build-report.md
          retention-days: 90